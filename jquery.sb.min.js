/*
  jQuery-SelectBox
  
  Traditional select elements are very difficult to style by themselves, 
  but they are also very usable and feature rich. This plugin attempts to 
  recreate all selectbox functionality and appearance while adding 
  animation and stylability.
  
  This product includes software developed 
  by RevSystems, Inc (http://www.revsystems.com/) and its contributors
  
  Please see the accompanying LICENSE.txt for licensing information.
*/
(function(d){d.fn.borderWidth=function(){return d(this).outerWidth()-d(this).innerWidth()};d.fn.paddingWidth=function(){return d(this).innerWidth()-d(this).width()};d.fn.extraWidth=function(){return d(this).outerWidth(true)-d(this).width()};d.fn.offsetFrom=function(g){var f=d(g);return{left:d(this).offset().left-f.offset().left,top:d(this).offset().top-f.offset().top}};d.fn.maxWidth=function(){var f=0;d(this).each(function(){if(d(this).width()>f){f=d(this).width()}});return f};d.fn.triggerAll=function(f,g){return d(this).each(function(){d(this).triggerHandler(f,g)})};var c=Array.prototype.slice,a=function(){return Math.floor(Math.random()*999999999)};d.proto=function(){var g=arguments[0],f=arguments[1],h=f,i={};opts=d.extend({elem:"elem",access:"access",init:"init"},arguments[2]);if(f._super){i[opts.init]=function(){};h=f.extend(i)}d.fn[g]=function(){var j,k=arguments;d(this).each(function(){var m,l=d(this),n=l.data(g);if(n===undefined){n=new h();if(f._super){n[opts.init]=f.prototype.init}n[opts.elem]=l[0];if(n[opts.init]){n[opts.init].apply(n,c.call(k,0))}l.data(g,n)}else{if(n[opts.access]){n[opts.access].apply(n,c.call(k,0))}if(k.length>0){if(d.isFunction(n[k[0]])){m=n[k[0]].apply(n,c.call(k,1));j=m}else{if(k.length===1){if(d.getObject){j=d.getObject(k[0],n)}else{j=n[k[0]]}}else{if(d.setObject){d.setObject(k[0],k[1],n)}else{n[k[0]]=k[1]}}}}else{if(j===undefined){j=l.data(g)}}}});if(j!==undefined){return d(this)}return j}};var b=function(){return false},e=function(){var l=this,M={},i=null,x=null,q=null,r=null,h=null,T=null,O="",B=null,N=null,L,R,j,n,U,Q,E,S,s,V,K,I,D,u,v,f,P,J,H,C,G,z,y,g,F,k,w,A,t,p,m;L=function(){q=d("<div class='sb "+M.selectboxClass+" "+i.attr("class")+"' id='sb"+a()+"'></div>").attr("role","listbox").attr("aria-has-popup","true").attr("aria-labelledby",x.attr("id")!=null?x.attr("id"):"");d("body").append(q);var W=i.children().size()>0?M.displayFormat.call(i.find("option:selected")[0],0,0):"&nbsp;";r=d("<a href='#' class='display "+i.attr("class")+"' id='sbd"+a()+"'></a>").append("<div class='text'>"+W+"</div>").append(M.arrowMarkup);q.append(r);h=d("<ul class='"+M.selectboxClass+" items "+i.attr("class")+"' role='menu' id='sbdd"+a()+"'></ul>").attr("aria-hidden","true");q.append(h).attr("aria-owns",h.attr("id"));if(i.children().size()===0){h.append(R())}else{i.children().each(function(X){var Y,Z,aa,ab;if(d(this).is("optgroup")){Z=d(this);aa=d("<li class='optgroup'>"+M.optgroupFormat.call(Z[0],X+1)+"</li>").addClass(Z.is(":disabled")?"disabled":"").attr("aria-disabled",Z.is(":disabled")?"true":"");ab=d("<ul class='items'></ul>");aa.append(ab);h.append(aa);Z.children("option").each(function(){Y=R(d(this),X).addClass(Z.is(":disabled")?"disabled":"").attr("aria-disabled",Z.is(":disabled")?"true":"");ab.append(Y)})}else{h.append(R(d(this),X))}})}T=h.find("li").not(".optgroup");q.attr("aria-active-descendant",T.filter(".selected").attr("id"));h.children(":first").addClass("first");h.children(":last").addClass("last");i.hide();if(!M.fixedWidth){var o=q.find(".text, .optgroup").maxWidth()+r.extraWidth()+1;q.width(M.maxWidth?Math.min(M.maxWidth,o):o);if(d.browser.msie&&d.browser.version<=7){T.find("a").each(function(){d(this).css("width","100%").width(d(this).width()-d(this).paddingWidth()-d(this).borderWidth())})}}else{if(M.maxWidth&&q.width()>M.maxWidth){q.width(M.maxWidth)}}i.before(q);h.hide();if(!i.is(":disabled")){x.bind("click.sb",j).bind("focus.sb",j);r.mousedown(K).click(b).focus(v).blur(f).hover(P,J);G().click(I).hover(P,J);h.find(".optgroup").hover(P,J).click(b);T.filter(".disabled").click(b)}else{q.addClass("disabled").attr("aria-disabled");r.click(function(X){X.preventDefault()})}q.bind("close.sb",s).bind("destroy.sb",n);i.bind("reload.sb",U);if(d.fn.tie&&M.useTie){i.bind("domupdate.sb",Q)}};R=function(X,o){if(!X){X=d("<option value=''>&nbsp;</option>");o=0}var Z=d("<li id='sbo"+a()+"'></li>").attr("role","option").data("value",X?X.attr("value"):"").addClass(X.is(":selected")?"selected":"").addClass(X.is(":disabled")?"disabled":"").attr("aria-disabled",X.is(":disabled")?"true":""),Y=d("<div class='item'></div>"),W=d("<div class='text'></div>").html(M.optionFormat.call(X[0],0,o+1));return Z.append(Y.append(W))};j=function(){r.focus()};n=function(){q.remove();i.unbind(".sb",U).unbind(".sb",Q).removeClass("has_sb").show();x.unbind(".sb",j).unbind(".sb",j);i.removeData(l.id)};U=function(){var W=q.is(".open"),o=r.is(".focused");s(true);n();l.init(M);if(W){r.focus();E(true)}else{if(o){r.focus()}}};Q=function(){clearTimeout(N);N=setTimeout(U,30)};t=function(){s();d(document).unbind("click",t)};w=function(){d(".sb.open."+M.selectboxClass).triggerAll("close")};p=function(){d(".sb.focused."+M.selectboxClass).not(q[0]).find(".display").blur()};A=function(){d(".sb.open."+M.selectboxClass).not(q[0]).triggerAll("close")};s=function(o){if(q.is(".open")){r.blur();T.removeClass("hover");d(document).unbind("keyup",D).unbind("keydown",m).unbind("keydown",u);h.attr("aria-hidden","true");if(o===true){h.hide();q.removeClass("open");q.append(h)}else{h.fadeOut(M.animDuration,function(){q.removeClass("open");q.append(h)})}}};H=function(){var o=null;if(M.ddCtx==="self"){o=q}else{if(d.isFunction(M.ddCtx)){o=d(M.ddCtx.call(i[0]))}else{o=d(M.ddCtx)}}return o};C=function(){return T.filter(".selected")};G=function(){return T.not(".disabled")};S=function(){h.scrollTop(h.scrollTop()+C().offsetFrom(h).top-h.height()/2+C().outerHeight(true)/2)};E=function(W){var o,X=H();p();q.addClass("open");X.append(h);o=V();if(d.browser.msie&&d.browser.version<8){d("."+M.selectboxClass+" .display").hide().show()}h.attr("aria-hidden","false");if(W===true){h.show();S()}else{if(o==="down"){h.slideDown(M.animDuration,S)}else{h.fadeIn(M.animDuration,S)}}d(document).click(t);r.focus()};V=function(){var X=H(),ae=0,W=r.offsetFrom(X).left,o=0,Z="",ad,ac,Y,af,ab,aa;h.removeClass("above");h.show().css({maxHeight:"none",position:"relative",});if(!M.fixedWidth){h.width(r.outerWidth()-h.extraWidth()+1)}ad=d(window).scrollTop()+d(window).height()-r.offset().top-r.outerHeight();ac=r.offset().top-d(window).scrollTop();Y=r.offsetFrom(X).top+r.outerHeight();af=ad-ac+M.dropupThreshold;if(h.outerHeight()<ad){ae=M.maxHeight?M.maxHeight:ad;o=Y;Z="down"}else{if(h.outerHeight()<ac){ae=M.maxHeight?M.maxHeight:ac;o=r.offsetFrom(X).top-Math.min(ae,h.outerHeight());Z="up"}else{if(af>=0){ae=M.maxHeight?M.maxHeight:ad;o=Y;Z="down"}else{if(af<0){ae=M.maxHeight?M.maxHeight:ac;o=r.offsetFrom(X).top-Math.min(ae,h.outerHeight());Z="up"}else{ae=M.maxHeight?M.maxHeight:"none";o=Y;Z="down"}}}}ab=d().jquery<"1.4.2"?d("body").offset().left:parseInt(d("body").css("margin-left"),10);aa=d().jquery<"1.4.2"?d("body").offset().top:parseInt(d("body").css("margin-top"),10);h.hide().css({left:W+(X[0].tagName.toLowerCase()==="body"?ab:0),maxHeight:ae,position:"absolute",top:o+(X[0].tagName.toLowerCase()==="body"?aa:0),visibility:"visible"});if(Z==="up"){h.addClass("above")}return Z};K=function(o){if(q.is(".open")){s()}else{E()}return false};z=function(){var W=d(this),o=i.val(),X=W.data("value");i.val(X);G().removeClass("selected");W.addClass("selected");q.attr("aria-active-descendant",W.attr("id"));r.find(".text").attr("title",W.find(".text").html());r.find(".text").html(M.displayFormat.call(i.find("option:selected")[0]));if(o!==X){i.change()}};I=function(o){z.call(this);t();r.focus();return false};y=function(){O=""};g=function(Y){var X,W,Z="",o=G();for(X=0;X<o.size();X++){W=o.eq(X).find(".text").text();Z+=W+" ";if(W.toLowerCase().match("^"+Y.toLowerCase())){return o.eq(X)}}return null};F=function(W){var o=g(W);if(o!==null){z.call(o[0]);return true}return false};m=function(o){if(o.which===38||o.which===40||o.which===8||o.which===32){o.preventDefault()}};k=function(Z){var Y,X,o=C(),W=G();for(Y=W.index(o)+1;Y<W.size();Y++){X=W.eq(Y).find(".text").text();if(X!==""&&X.substring(0,1).toLowerCase()===Z.toLowerCase()){z.call(W.eq(Y)[0]);return true}}return false};u=function(W){if(W.altKey||W.ctrlKey){return false}var o=C();switch(W.which){case 35:if(o.size()>0){W.preventDefault();z.call(G().filter(":last")[0]);S()}break;case 36:if(o.size()>0){W.preventDefault();z.call(G().filter(":first")[0]);S()}break;case 38:if(o.size()>0){if(G().filter(":first")[0]!==o[0]){W.preventDefault();z.call(G().eq(G().index(o)-1)[0])}S()}break;case 40:if(o.size()>0){if(G().filter(":last")[0]!==o[0]){W.preventDefault();z.call(G().eq(G().index(o)+1)[0]);S()}}else{if(T.size()>1){W.preventDefault();z.call(T.eq(0)[0])}}break;default:break}};D=function(o){if(o.altKey||o.ctrlKey){return false}if(o.which!==38&&o.which!==40){O+=String.fromCharCode(o.keyCode);if(F(O)){clearTimeout(B);B=setTimeout(y,M.acTimeout)}else{if(k(String.fromCharCode(o.keyCode))){S();clearTimeout(B);B=setTimeout(y,M.acTimeout)}else{y();clearTimeout(B)}}}};v=function(){A();q.addClass("focused");d(document).unbind("keyup",D).keyup(D).unbind("keydown",m).keydown(m).keydown(u).unbind("keydown",u).keydown(u)};f=function(){q.removeClass("focused");d(document).unbind("keyup",D).unbind("keydown",m).unbind("keydown",u)};P=function(){d(this).addClass("hover")};J=function(){d(this).removeClass("hover")};this.init=function(o){if(d.browser.msie&&d.browser.version<7){return}i=d(this.elem);if(i.attr("id")){x=d("label[for='"+i.attr("id")+"']:first")}if(!x||x.size()==0){x=i.closest("label")}if(i.hasClass("has_sb")){return}else{i.addClass("has_sb")}M=d.extend({acTimeout:800,animDuration:200,ddCtx:"body",dropupThreshold:150,fixedWidth:false,maxHeight:false,maxWidth:false,selectboxClass:"selectbox",useTie:false,arrowMarkup:"<div class='arrow_btn'><span class='interior'><span class='arrow'></span></span></div>",displayFormat:function(){if(d(this).size()>0){var W=d(this).attr("label");if(W!==""){return W}return d(this).text()}else{return""}},optionFormat:function(W,Y){var X=d(this).attr("label");if(X!==""){return X}return d(this).text()},optgroupFormat:function(W){return"<span class='label'>"+d(this).attr("label")+"</span>"}},o);L()};this.open=E;this.close=s;this.refresh=U;this.destroy=n;this.options=function(o){M=d.extend(M,o);U()}};d.proto("sb",e)}(jQuery));